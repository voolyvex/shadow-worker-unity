name: Acquire Unity activation file
on: workflow_dispatch

jobs:
  activation:
    name: Request manual activation file ðŸ”‘
    runs-on: ubuntu-latest
    steps:
      # Request manual activation file
      - name: Request manual activation file
        id: getManualLicenseFile
        uses: actions/checkout@v4
        
      - name: Request activation file job
        run: |
          sudo apt-get update
          sudo apt-get install -y xvfb
          
          # Install Unity Hub
          wget -qO - https://hub.unity3d.com/linux/keys/public | gpg --dearmor | sudo tee /usr/share/keyrings/unity-hub.gpg > /dev/null
          echo "deb [signed-by=/usr/share/keyrings/unity-hub.gpg] https://hub.unity3d.com/linux/repos/deb stable main" | sudo tee /etc/apt/sources.list.d/unity-hub.list
          sudo apt update
          sudo apt install -y unity-hub
          
          # Install Unity Editor
          unity-hub -- --headless install-path --set /opt/unity
          unity-hub -- --headless install 6000.0.34f1
          
          # Create activation file
          xvfb-run --auto-servernum --server-args='-screen 0 640x480x24' \
            /opt/unity/Editor/Unity \
            -batchmode \
            -nographics \
            -logFile /dev/stdout \
            -createManualActivationFile \
            -quit
          
      # Upload artifact (Unity_v20XX.X.XXXX.alf)
      - name: Upload activation file
        uses: actions/upload-artifact@v4
        with:
          name: Unity_v6000.0.34f1.alf
          path: Unity_v6000.0.34f1.alf
          retention-days: 1

      - name: Next steps
        run: |
          echo "Manual activation file has been created and uploaded as an artifact."
          echo "Please follow these steps:"
          echo "1. Download the Unity_v6000.0.34f1.alf file from the artifacts"
          echo "2. Visit https://license.unity3d.com/manual"
          echo "3. Upload the .alf file"
          echo "4. Download the Unity_v6000.0.34f1.ulf file"
          echo "5. Create a new repository secret named UNITY_LICENSE"
          echo "6. Copy the entire contents of the .ulf file into the secret value"
